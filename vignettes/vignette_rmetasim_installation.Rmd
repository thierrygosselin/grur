---
title: "rmetasim-XGBoost-LightGBM installation"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

`grur` RADseq-based simulation framework will almost always require more markers
than the default built-in threshold in `rmetasim`, the `R` simulation engine
used by `grur`.

This vignette purposes is to show users how to modify/install
`rmetasim` to allow it to use more markers during simulations, than the 
latest default set to 2000 markers.

Additionally, macOS users will find the instructions to install
`XGBoost` and `LightGBM` so that the package work in parallel,
both need to be compiled with OpenMP enabled.


**Time to allow: ETA ~10 min**

#Update [clang](https://en.wikipedia.org/wiki/Clang) 

##macOS
We want clang compiler with OpenMP enabled
```{r}
#Terminal
cd Downloads
wget http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
tar -xzvf clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

**Move and Rename clang** to a folder in your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time):
```{r}
#Terminal
sudo mv clang+llvm-5.0.0-x86_64-apple-darwin ~/Dropbox/programs/clang
```

**Delete** downloaded files:
```{r}
sudo rm clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

##Linux
Several flavors available, check for the proper [link](http://releases.llvm.org/download.html)


#Modify your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time)

Open the [`.bash_profile`](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=bash_profile#save-time) file with Terminal *nano* or [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) or another text editor:
```{r}
export C_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/clang-c:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/c++:$CPLUS_INCLUDE_PATH
```

#Modify *R's* `~/.R/Makevars` file

This is exactly the same step required to install [randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) and 
[data.table](https://github.com/Rdatatable/data.table) to work in parallel.
This is detailed in this vignette: [vignette_imputations_parallel](https://github.com/thierrygosselin/grur/blob/master/vignettes/vignette_imputations_parallel.Rmd)

With macOS use [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) to open the file with `Show hidden items` turned `ON`. You want these lines:
```{r}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
FC=/usr/local/bin/gfortran
F77=/usr/local/bin/gfortran
PKG_LIBS = -fopenmp -lgomp
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
SHLIB_OPENMP_CFLAGS = -fopenmp
SHLIB_OPENMP_CXXFLAGS = -fopenmp
SHLIB_OPENMP_FCFLAGS = -fopenmp
SHLIB_OPENMP_FFLAGS = -fopenmp
FLIBS=-L/usr/local/lib/gcc/x86_64-apple-darwin15.6.0/7.1.0/finclude # change according to your computer compiler version
CFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
CXXFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
```

If you don't have the file, use sudo nano in the Terminal to create one:
```{r}
cd ~
sudo mkdir ~/.R
sudo nano ~/.R/Makevars
```
Copy/paste the section above. Save and Exit with: `crt-o`, `enter`, `crt-x`.

#`rmetasim`
Hang in there it's almost over...

Download the latest github release of Allan Strand's **rmetasim**

##In R
```{r download rmetasim, echo=TRUE}
utils::download.file(
  url = "https://github.com/stranda/rmetasim/archive/master.zip",
  destfile = "grur_rmetasim.zip")
#unzip the file
utils::unzip(zipfile = "grur_rmetasim.zip")
```


##in Terminal
```{r}
cd Downloads
wget https://github.com/stranda/rmetasim/archive/master.zip
unzip master.zip
```

## 1 quick modification

###Using a text editor

With macOS use [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) to modify the `const.h` file in the `src` folder: `rmetasim-master/src/const.h`.
Navigate to **lane 33** and change the integer to the maximum number of marker
your likely to use.

###With *nano* in the Terminal
```{r edit in nano}
sudo nano rmetasim-master/src/const.h
# change

#define MAXLOCI               2000

# to

#define MAXLOCI               200000

```

Keep lines with `#`. Save and exit *nano*
```{r save and exit nano}
ctrl-o
enter
ctrl-x
```

###Compile `rmetasim`

```{r}
#Terminal
R CMD INSTALL "rmetasim-master"
```

*Warning*: Using `devtools::install` will not work with current `devtools` CRAN version [details](https://community.rstudio.com/t/difference-between-r-cmd-install-and-devtools-install/1441/3).
The devel version will work using:

```{r}
devtools::install_github("hadley/devtools")
devtools::install("~/Downloads/rmetasim-master")
```


###What to expect
There sould be some warning messages, not to worry, Allan says it's normal.
However, at the end you should see something like this:
```{r}
** R
** inst
** preparing package for lazy loading
** help
*** installing help indices
** building package indices
** installing vignettes
   ‘ApplyCarryToStage.Rmd’ using ‘UTF-8’ 
   ‘CreatingLandscapes.Rmd’ using ‘UTF-8’ 
   ‘Sexuality-and-mating.Rmd’ using ‘UTF-8’ 
   ‘Simulating.Rmd’ using ‘UTF-8’ 
   ‘rmetasim.Rmd’ using ‘UTF-8’ 
** testing if installed package can be loaded
* DONE (rmetasim)
```


###Remove folders
```{r removing downloaded folders}
#Terminal
cd ..
sudo rm -R grur_rmetasim.zip rmetasim-master
```


#XGBoost

##Download the github version
```{r}
# In RStudio Terminal or macOS Terminal
cd Downloads
git clone --recursive https://github.com/dmlc/xgboost
cd xgboost
```


##CMD line mode only

To compile XGBoost and run in command line mode in the Terminal
```{r}
cp make/config.mk ./config.mk
export CC=/usr/local/bin/gcc
export CXX=/usr/local/bin/g++
export CXX11=/usr/local/bin/g++
export CXX14=/usr/local/bin/g++
export CXX17=/usr/local/bin/g++
make -j4
```

Prefer using CLANG instead of GCC ? (in dev)
```{r}
export CC=/Users/thierry/Dropbox/programs/clang/bin/clang
export CXX=/Users/thierry/Dropbox/programs/clang/bin/clang++
export CXX1X=/Users/thierry/Dropbox/programs/clang/bin/clang++
```


##R package
Modify the `configure` file inside the `xgboost/R-package` folder

###In a text editor
```{r edit xgboost}
# Go to line 1676
# change
  ac_pkg_openmp=no
# to
  ac_pkg_openmp=yes
#save the file under the same name
```

###Compile `XGBoost`

```{r}
sudo R CMD INSTALL R-package
```

##Test R-package
You should see a time difference between both runs

```{r}
require(xgboost)
x <-  matrix(rnorm(100*10000), 10000, 100)
y <-  x %*% rnorm(100) + rnorm(1000)

system.time({bst = xgboost(data = x, label = y, nthread = 1, nround = 100, verbose = FALSE)})
system.time({bst = xgboost(data = x, label = y, nthread = 4, nround = 100, verbose = FALSE)})
```



---
title: "Computer setup for genomics in R"
output: 
  html_notebook:
    toc: true
    toc_float: true
---
This vignette purposes is to show users how to install packages required
for imputations inside `grur`. The vignette is also useful to prepare computers
for genomic analysis inside R. 

There's a more detailed computer setup tutorial found [here](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html)


`grur` RADseq-based simulation framework uses `rmetasim`, an `R` simulation engine.
This vignette will show users how to modify `rmetasim`, so
that it can be used with more than 2000 markers, the current built-in default. 
We also show how to compile `rmetasim` to install it.

Additionally, macOS and Linux users will find the instructions to install
`XGBoost`, `LightGBM`, `ranger`, `missRanger`, `randomForestSRC` and 
`pcaMethods` so that the packages works in parallel,
some need to be compiled with OpenMP enabled.


**Time to allow: ETA ~15 min**

#macOS

##Apple's Command Line Tools

Make sure it's installed...if not, follow instructions:
```{r}
xcode-select --install
```

##Compiler
Apple can't ship GNU Compiler Collection (GCC) with OpenMP enabled,
similar story with Clang the other compiler used in macOS. Consequently,
both need to be updateed manually.

###Update GCC

Choose the binary version number based on your OS.

**High Sierra, Sierra & El Capitan:** gcc-7.1-bin.tar.gz

**Yosemite:** gcc-5.1-bin.tar.gz

```{sh}
cd Downloads
wget http://prdownloads.sourceforge.net/hpc/gcc-7.1-bin.tar.gz#change version accordingly
# This will install the compiler in `/usr/local/bin`
sudo tar -zxvf gcc-7.1-bin.tar.gz -C/
# to remove the package from your Downloads directory
sudo rm gcc-7.1-bin.tar.gz
# to check the installation
gcc -v
```


###Update Clang

We want [clang](https://en.wikipedia.org/wiki/Clang) compiler with OpenMP enabled.

```{sh}
#Terminal
cd Downloads
wget http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
tar -xzvf clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

**Move and Rename clang** to a folder in your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time):
```{sh}
#Terminal
sudo mv clang+llvm-5.0.0-x86_64-apple-darwin ~/Dropbox/programs/clang
```

**Delete** downloaded files:
```{sh}
sudo rm clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

**Modify your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time)**

Open the [`.bash_profile`](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=bash_profile#save-time) file with Terminal *nano* or [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) or another text editor:
```{sh}
export C_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/clang-c:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/c++:$CPLUS_INCLUDE_PATH
```

#Linux

Make sure you have GCC and CLANG with OpenMP enabled.
Several flavors available, check for the proper [link](http://releases.llvm.org/download.html)



#Makevars file

You need to tell R how to use the compilers. This might change from one package
to another. Nothing is simple, you know this by now...
All this is done through R's `~/.R/Makevars` file.

Below, are exactly the same steps required to install [randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) and 
[data.table](https://github.com/Rdatatable/data.table) to work in parallel.
This is detailed in this vignette: [vignette_imputations_parallel](https://github.com/thierrygosselin/grur/blob/master/vignettes/vignette_imputations_parallel.Rmd)

With macOS use [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) to open the file with `Show hidden items` turned `ON`. You want these lines:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
FC=/usr/local/bin/gfortran
F77=/usr/local/bin/gfortran
PKG_LIBS = -fopenmp -lgomp
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
SHLIB_OPENMP_CFLAGS = -fopenmp
SHLIB_OPENMP_CXXFLAGS = -fopenmp
SHLIB_OPENMP_FCFLAGS = -fopenmp
SHLIB_OPENMP_FFLAGS = -fopenmp
FLIBS=-L/usr/local/lib/gcc/x86_64-apple-darwin15.6.0/7.1.0/finclude # change according to your computer compiler version
CFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
CXXFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
```

If you don't have the file, use sudo nano in the Terminal to create one:
```{sh}
cd ~
sudo mkdir ~/.R
sudo nano ~/.R/Makevars
```
Copy/paste the section above. Save and Exit with: `crt-o`, `enter`, `crt-x`.

#`rmetasim`
Hang in there it's almost over...


##Download
Download the latest github release of Allan Strand's **rmetasim**
```{sh}
cd Downloads
wget https://github.com/stranda/rmetasim/archive/master.zip
unzip master.zip
```

##MAXLOCI

2000 loci is the built-in maximum. To use more, you need to modify rmetasim before compiling.
With a text editor [e.g. TextWrangler with macOS](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler), modify the `const.h` file in the `src` folder: `rmetasim-master/src/const.h`.
Navigate to **lane 33** and change the integer to the desired maximum number of loci.

```{sh}
#define MAXLOCI               2000
```

```{sh}
#define MAXLOCI               20000
```

##Makevars configuration
*rmetasim* requires these Makevars specifications. If you have other lines, comment (#)
before compiling:


```{sh}
CC=/Users/thierry/Dropbox/programs/clang/bin/clang # -fopenmp
CC=/Users/thierry/Dropbox/programs/clang/bin/clang
CXX=/Users/thierry/Dropbox/programs/clang/bin/clang++
CXX1X=/Users/thierry/Dropbox/programs/clang/bin/clang++
FLIBS=-L/Users/thierry/Dropbox/programs/clang/lib
LDFLAGS=-L/Users/thierry/Dropbox/programs/clang/lib -L/usr/local/opt/gettext/lib
CPPFLAGS=-I/Users/thierry/Dropbox/programs/clang/include -I/usr/local/opt/gettext/include
SHLIB_OPENMP_CFLAGS= -fopenmp
SHLIB_OPENMP_FCFLAGS= -fopenmp
SHLIB_OPENMP_FFLAGS= -fopenmp
SHLIB_OPENMP_CXXFLAGS= -fopenmp
```


##Compile
```{sh}
R CMD INSTALL "rmetasim-master" # Terminal command
sudo rm -R rmetasim-master master.zip # to remove the folders no longer required
```

#`XGBoost`

##Download the github version
```{sh}
# terminal
cd Downloads
git clone --recursive https://github.com/dmlc/xgboost
cd xgboost
```

##Modification
Modify in a text editor the `configure` file inside the `xgboost/R-package` folder:
```{sh}
# Go to line 1676
# change
  ac_pkg_openmp=no
# to
  ac_pkg_openmp=yes
#save the file under the same name
```

##Makevars configuration

`XGBoost` requires these Makevars specifications. If you have other lines, comment (#)
before compiling:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CXX11=/usr/local/bin/g++
CXX14=/usr/local/bin/g++
CXX17=/usr/local/bin/g++
```


##Compile
```{sh}
sudo R CMD INSTALL R-package
```

##Test R-package
You should see a time difference between both runs
```{r}
require(xgboost)
x <-  matrix(rnorm(100*10000), 10000, 100)
y <-  x %*% rnorm(100) + rnorm(1000)

system.time({bst = xgboost(data = x, label = y, nthread = 1, nround = 100, verbose = FALSE)})
system.time({bst = xgboost(data = x, label = y, nthread = 4, nround = 100, verbose = FALSE)})
```


#`LightGBM`

`LightGBM` requires an OpenMP-enabled compiler. Currently, it doesn't work well with
clang, so make sure you have updated your GCC compiler (instructions above).
Additionally, `LightGBM` requires [CMake](https://cmake.org/overview/)

##Download and install CMake
```{sh}
cd Downloads
wget https://cmake.org/files/v3.10/cmake-3.10.0-rc3-Darwin-x86_64.dmg
# double-click on the disk image and follow instructions
```


To add CMake to the PATH:
```{sh}
PATH="/Applications/CMake.app/Contents/bin":"$PATH"
# Or, to install symlinks to '/usr/local/bin', run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install
# Or, to install symlinks to another directory, run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install=/path/to/bin
Then, run the following commands to install LightGBM:
```

##Download and Install LightGBM
```{sh}
cd Downloads
git clone --recursive https://github.com/Microsoft/LightGBM
cd LightGBM/R-package
export CC=/usr/local/bin/gcc CXX=/usr/local/bin/g++
R CMD INSTALL --build . --no-multiarch
```



#`randomForestSRC`
[randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) requires 
the GCC OpenMP-enabled compiler to run in parallel. 
See instructions above if not already done.


##Makevars configuration
Check that the lines below **are not** commented in your `~/.R/Makevars` file:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CFLAGS=-g -O3 -Wall -pedantic -std=gnu99 -mtune=native -pipe
CXXFLAGS=-g -O3 -Wall -pedantic -std=c++11 -mtune=native -pipe
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
```

##Download and install
From the Terminal run these steps to download and compile randomForestSRC:
```{sh}
cd ~/Downloads
curl -O http://www.ccs.miami.edu/~hishwaran/rfsrc/randomForestSRC_2.5.0.tar.gz
tar -zxvf randomForestSRC_2.5.0.tar.gz
cd randomForestSRC
autoconf
cd ..
R CMD INSTALL --preclean --clean randomForestSRC
```

You want to make sure that this line is printed during execution of the previous command:
`checking whether OpenMP will work in a package... yes`

If the compilation fails after `autoconf`, follow the first 3 steps in this
[tutorial](http://gbs-cloud-tutorial.readthedocs.io/en/latest/07_start_from_new_image.html?highlight=autoconf#install-gbs-radseq-software-time-required-30min), to install `libsigsegv`, `m4` and `autoconf`. 


#`ranger`
[ranger](https://github.com/imbs-hl/ranger) is easy to install.
```{r}
install.packages("ranger")
```

#`missRanger`
[missRanger](https://github.com/mayer79/missRanger) is also very easy to install.
```{r}
install.packages("missRanger")
```


#`pcaMethods`
To install [pcaMethods](https://github.com/hredestig/pcaMethods), from bioconductor:
```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("pcaMethods")
```

---
title: "Computer setup for genomics in R"
output: 
  html_notebook:
    toc: true
    toc_float: true
---

There's a more detailed computer setup tutorial found [here](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html)


`grur` RADseq-based simulation framework will almost always require more markers
than the default built-in threshold in `rmetasim`, the `R` simulation engine
used by `grur`.

This vignette purposes is to show users how to modify/install
`rmetasim` to allow it to use more markers during simulations, than the 
latest default set to 2000 markers.

Additionally, macOS users will find the instructions to install
`XGBoost`, `LightGBM`, `ranger`, `missRanger`, and `randomForestSRC`
so that the packages works in parallel,
some need to be compiled with OpenMP enabled.


**Time to allow: ETA ~15 min**

#macOS

##Apple's Command Line Tools

Make sure it's installed...if not, follow instructions:
```{r}
xcode-select --install
```


##Update GCC

Apple can't ship GNU Compiler Collection with OpenMP enabled, so you need to
install it manually. Choose the binary version number based on your OS.

**High Sierra, Sierra & El Capitan:** gcc-7.1-bin.tar.gz

**Yosemite:** gcc-5.1-bin.tar.gz

```{r}
cd Downloads
wget http://prdownloads.sourceforge.net/hpc/gcc-7.1-bin.tar.gz#change version accordingly
# This will install the compiler in `/usr/local/bin`
sudo tar -zxvf gcc-7.1-bin.tar.gz -C/
# to remove the package from your Downloads directory
sudo rm gcc-7.1-bin.tar.gz
# to check the installation
gcc -v
```


##Update Clang

It's the same story with [clang](https://en.wikipedia.org/wiki/Clang), we want
clang compiler with OpenMP enabled.

```{r}
#Terminal
cd Downloads
wget http://releases.llvm.org/5.0.0/clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
tar -xzvf clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

**Move and Rename clang** to a folder in your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time):
```{r}
#Terminal
sudo mv clang+llvm-5.0.0-x86_64-apple-darwin ~/Dropbox/programs/clang
```

**Delete** downloaded files:
```{r}
sudo rm clang+llvm-5.0.0-x86_64-apple-darwin.tar.xz
```

###Modify your [PATH](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=PATH#save-time)

Open the [`.bash_profile`](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html?highlight=bash_profile#save-time) file with Terminal *nano* or [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) or another text editor:
```{r}
export C_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/clang-c:$C_INCLUDE_PATH
export CPLUS_INCLUDE_PATH=/install/prefix/include:$HOME/Dropbox/programs/clang/include/c++:$CPLUS_INCLUDE_PATH
```

#Linux

Make sure you have GCC and CLANG with OpenMP enabled.
Several flavors available, check for the proper [link](http://releases.llvm.org/download.html)



#*R's* `~/.R/Makevars` file

You need to tell R how to use the compilers. This might change from one package
to another. Nothing is simple, you know this by now...
All this is done through R's Makevars file. 

Below, are exactly the same steps required to install [randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) and 
[data.table](https://github.com/Rdatatable/data.table) to work in parallel.
This is detailed in this vignette: [vignette_imputations_parallel](https://github.com/thierrygosselin/grur/blob/master/vignettes/vignette_imputations_parallel.Rmd)

With macOS use [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) to open the file with `Show hidden items` turned `ON`. You want these lines:
```{r}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
FC=/usr/local/bin/gfortran
F77=/usr/local/bin/gfortran
PKG_LIBS = -fopenmp -lgomp
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
SHLIB_OPENMP_CFLAGS = -fopenmp
SHLIB_OPENMP_CXXFLAGS = -fopenmp
SHLIB_OPENMP_FCFLAGS = -fopenmp
SHLIB_OPENMP_FFLAGS = -fopenmp
FLIBS=-L/usr/local/lib/gcc/x86_64-apple-darwin15.6.0/7.1.0/finclude # change according to your computer compiler version
CFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
CXXFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
```

If you don't have the file, use sudo nano in the Terminal to create one:
```{r}
cd ~
sudo mkdir ~/.R
sudo nano ~/.R/Makevars
```
Copy/paste the section above. Save and Exit with: `crt-o`, `enter`, `crt-x`.

#`rmetasim`
Hang in there it's almost over...

Download the latest github release of Allan Strand's **rmetasim**

##In R
```{r download rmetasim, echo=TRUE}
utils::download.file(
  url = "https://github.com/stranda/rmetasim/archive/master.zip",
  destfile = "grur_rmetasim.zip")
#unzip the file
utils::unzip(zipfile = "grur_rmetasim.zip")
```


##in Terminal
```{r}
cd Downloads
wget https://github.com/stranda/rmetasim/archive/master.zip
unzip master.zip
```

## 1 quick modification

###Using a text editor

With macOS use [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) to modify the `const.h` file in the `src` folder: `rmetasim-master/src/const.h`.
Navigate to **lane 33** and change the integer to the maximum number of marker
your likely to use.

###With *nano* in the Terminal
```{r edit in nano}
sudo nano rmetasim-master/src/const.h
# change

#define MAXLOCI               2000

# to

#define MAXLOCI               200000

```

Keep lines with `#`. Save and exit *nano*
```{r save and exit nano}
ctrl-o
enter
ctrl-x
```

###Makevars configuration
*rmetasim* requires these Makevars specifications. If you have other lines, comment (#)
before compiling:


```{r}
CC=/Users/thierry/Dropbox/programs/clang/bin/clang # -fopenmp
CC=/Users/thierry/Dropbox/programs/clang/bin/clang
CXX=/Users/thierry/Dropbox/programs/clang/bin/clang++
CXX1X=/Users/thierry/Dropbox/programs/clang/bin/clang++
FLIBS=-L/Users/thierry/Dropbox/programs/clang/lib
LDFLAGS=-L/Users/thierry/Dropbox/programs/clang/lib -L/usr/local/opt/gettext/lib
CPPFLAGS=-I/Users/thierry/Dropbox/programs/clang/include -I/usr/local/opt/gettext/include
SHLIB_OPENMP_CFLAGS= -fopenmp
SHLIB_OPENMP_FCFLAGS= -fopenmp
SHLIB_OPENMP_FFLAGS= -fopenmp
SHLIB_OPENMP_CXXFLAGS= -fopenmp
```


###Compile `rmetasim`

```{r}
#Terminal
R CMD INSTALL "rmetasim-master"
```

*Warning*: Using `devtools::install` will not work with current `devtools` CRAN version [details](https://community.rstudio.com/t/difference-between-r-cmd-install-and-devtools-install/1441/3).
The devel version will work using:

```{r}
devtools::install_github("hadley/devtools")
devtools::install("~/Downloads/rmetasim-master")
```


If you get an error saying `Error: invalid version specification ‘>=3.4.0’`,
open *rmetasim* `DESCRIPTION` file, and change `Depends: R (>=3.4.0)` to
`Depends: R (>= 3.4.0)`. There's a space between `>=` and `3.4.0`.


###What to expect
There sould be some warning messages, not to worry, Allan says it's normal.
However, at the end you should see something like this:
```{r}
** R
** inst
** preparing package for lazy loading
** help
*** installing help indices
** building package indices
** installing vignettes
   ‘ApplyCarryToStage.Rmd’ using ‘UTF-8’ 
   ‘CreatingLandscapes.Rmd’ using ‘UTF-8’ 
   ‘Sexuality-and-mating.Rmd’ using ‘UTF-8’ 
   ‘Simulating.Rmd’ using ‘UTF-8’ 
   ‘rmetasim.Rmd’ using ‘UTF-8’ 
** testing if installed package can be loaded
* DONE (rmetasim)
```


###Remove folders
```{r removing downloaded folders}
#Terminal
cd ..
sudo rm -R grur_rmetasim.zip rmetasim-master
```


#XGBoost

##Download the github version
```{r}
# In RStudio Terminal or macOS Terminal
cd Downloads
git clone --recursive https://github.com/dmlc/xgboost
cd xgboost
```


##CMD line mode only

To compile XGBoost and run in command line mode in the Terminal
```{r}
cp make/config.mk ./config.mk
export CC=/usr/local/bin/gcc
export CXX=/usr/local/bin/g++
export CXX11=/usr/local/bin/g++
export CXX14=/usr/local/bin/g++
export CXX17=/usr/local/bin/g++
make -j4
```

Prefer using CLANG instead of GCC ? (in dev)
```{r}
export CC=/Users/thierry/Dropbox/programs/clang/bin/clang
export CXX=/Users/thierry/Dropbox/programs/clang/bin/clang++
export CXX1X=/Users/thierry/Dropbox/programs/clang/bin/clang++
```


##R package
Modify the `configure` file inside the `xgboost/R-package` folder:

###In a text editor
```{r edit xgboost}
# Go to line 1676
# change
  ac_pkg_openmp=no
# to
  ac_pkg_openmp=yes
#save the file under the same name
```

###Makevars configuration for XGBoost

*XGBoost* requires these Makevars specifications. If you have other lines, comment (#)
before compiling:

```{r}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CXX11=/usr/local/bin/g++
CXX14=/usr/local/bin/g++
CXX17=/usr/local/bin/g++
```


###Compile `XGBoost`

```{r}
sudo R CMD INSTALL R-package
```

##Test R-package
You should see a time difference between both runs

```{r}
require(xgboost)
x <-  matrix(rnorm(100*10000), 10000, 100)
y <-  x %*% rnorm(100) + rnorm(1000)

system.time({bst = xgboost(data = x, label = y, nthread = 1, nround = 100, verbose = FALSE)})
system.time({bst = xgboost(data = x, label = y, nthread = 4, nround = 100, verbose = FALSE)})
```


#LightGBM

LightGBM requires an OpenMP-enabled compiler. Currently, it doesn't work well with
clang, so make sure you have updated your GCC compiler (instructions above).
Additionally, LightGBM requires [CMake](https://cmake.org/overview/)

##Install CMake
```{r}
cd Downloads
wget https://cmake.org/files/v3.10/cmake-3.10.0-rc3-Darwin-x86_64.dmg
# double-click on the disk image and follow instructions
```


To add CMake to the PATH:

```{r}
PATH="/Applications/CMake.app/Contents/bin":"$PATH"
# Or, to install symlinks to '/usr/local/bin', run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install
# Or, to install symlinks to another directory, run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install=/path/to/bin
Then, run the following commands to install LightGBM:
```

##Download and Install LightGBM
```{r}
cd Downloads
git clone --recursive https://github.com/Microsoft/LightGBM
cd LightGBM/R-package
export CC=/usr/local/bin/gcc CXX=/usr/local/bin/g++
R CMD INSTALL --build . --no-multiarch
```



#randomForestSRC

[randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) requires 
the GCC OpenMP-enabled compiler to run in parallel. 
See instructions above if not already done.


Check that the lines below **are not** commented in your `~/.R/Makevars` file:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CFLAGS=-g -O3 -Wall -pedantic -std=gnu99 -mtune=native -pipe
CXXFLAGS=-g -O3 -Wall -pedantic -std=c++11 -mtune=native -pipe
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
```



From the Terminal run these steps to compile randomForestSRC:
```{sh}
cd ~/Downloads
curl -O http://www.ccs.miami.edu/~hishwaran/rfsrc/randomForestSRC_2.5.0.tar.gz
tar -zxvf randomForestSRC_2.5.0.tar.gz
cd randomForestSRC
autoconf
cd ..
R CMD INSTALL --preclean --clean randomForestSRC
```

You want to make sure that this line is printed during execution of the previous command:
`checking whether OpenMP will work in a package... yes`

If the compilation fails after `autoconf`, follow the first 3 steps in this
[tutorial](http://gbs-cloud-tutorial.readthedocs.io/en/latest/07_start_from_new_image.html?highlight=autoconf#install-gbs-radseq-software-time-required-30min), to install `libsigsegv`, `m4` and `autoconf`. 


#ranger
[ranger](https://github.com/imbs-hl/ranger) is easy to install.

To install the ranger R package from CRAN:
```{r}
install.packages("ranger")
```

To install the development version from GitHub using devtools, run
```{r}
devtools::install_github("imbs-hl/ranger")
```

#missRanger
[missRanger](https://github.com/mayer79/missRanger) is also very easy to install.

From CRAN:
```{r}
install.packages("missRanger")
```


#pcaMethods
To install [pcaMethods](https://github.com/hredestig/pcaMethods), from bioconductor:

```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("pcaMethods")
```

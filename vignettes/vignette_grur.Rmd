---
title: "Computer setup for genomics in R"
output: 
  html_notebook:
    toc: true
    toc_float: true
---
This vignette purposes is to show users how to install packages required
for imputations inside `grur`. The vignette is also useful to prepare computers
for genomic analysis inside R. 

There's a more detailed computer setup tutorial found [here](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html)


`grur` RADseq-based simulation framework uses `rmetasim`, an `R` simulation engine.
This vignette will show users how to modify `rmetasim`, so
that it can be used with more than 2000 markers, the current built-in default. 
We also show how to compile `rmetasim` to install it.

Additionally, macOS and Linux users will find the instructions to install
`XGBoost`, `LightGBM`, `ranger`, `missRanger`, `randomForestSRC` and 
`pcaMethods` so that the packages works in parallel,
some need to be compiled with OpenMP enabled.


**Time to allow: ETA ~20 min**

#macOS

##Apple's Command Line Tools

Make sure it's installed...if not, follow instructions:
```{r}
xcode-select --install
```

##Compiler
Apple can't ship GNU Compiler Collection (GCC) with OpenMP enabled,
similar story with Clang the other compiler used in macOS. Consequently,
both need to be updateed manually.

The command below fro both GCC and Clang will:

* change directory to your downloads
* download the compiler's binaries 
* uncompress and move folders (`bin`, `include`, `lib`, `libexec` and `share`) of the compiler on your computer `/usr/local` directory.
* remove the downloaded file
* check the version of gcc

###Update GCC

Choose the binary version number based on your OS and change the version accordingly.

**High Sierra, Sierra & El Capitan:** gcc-7.1-bin.tar.gz

**Yosemite:** gcc-5.1-bin.tar.gz

```{sh}
cd Downloads
wget http://prdownloads.sourceforge.net/hpc/gcc-7.1-bin.tar.gz 
sudo tar -zxvf gcc-7.1-bin.tar.gz -C/
```

```{sh}
sudo rm gcc-7.1-bin.tar.gz
gcc -v
```

###Update Clang

We want [clang](https://en.wikipedia.org/wiki/Clang) compiler with OpenMP enabled.

```{sh}
cd Downloads
wget http://releases.llvm.org/5.0.1/clang+llvm-5.0.1-x86_64-apple-darwin.tar.xz
sudo tar -xzvf clang+llvm-5.0.1-x86_64-apple-darwin.tar.xz -C/usr/local --strip-components 1
```


```{sh}
sudo rm clang+llvm-5.0.1-x86_64-apple-darwin.tar.xz
clang -v
```


#Linux

Make sure you have GCC and CLANG with OpenMP enabled.
Several flavors available, check for the proper [link](http://releases.llvm.org/download.html)

#Install R

To install R v.3.4.3 *Kite-Eating Tree* released on 2017/11/30 download the
installer and follow the instructions
```{sh}
cd Downloads
wget https://cran.r-project.org/bin/macosx/R-3.4.3.pkg
```



**To remove R completely from macOS**
```{sh}
sudo rm -rf /Library/Frameworks/R.framework /Applications/R.app \
   /usr/bin/R /usr/bin/Rscript
```

#Rstudio

To download RStudio, check thin [link](https://www.rstudio.com/products/rstudio/download/#download)
and download the installer for your OS.


#Makevars file

You need to tell R how to use the compilers. This might change from one package
to another. Nothing is simple, you know this by now...
All this is done through R's `~/.R/Makevars` file.

If you don't have the file, the fastest way is to use the built-in nano editor in the Terminal to create one:
```{sh}
cd ~
mkdir ~/.R
```

```{sh}
nano ~/.R/Makevars
```
Copy/paste the section below (Makevars content). Save and Exit with: `crt-o`, `enter`, `crt-x`.

If you already have the *Makevars* file macOS [TextWrangler](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler) can be use to open the file with `Show hidden items` turned `ON`. 


**Makevars content required:**
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
FC=/usr/local/bin/gfortran
F77=/usr/local/bin/gfortran
PKG_LIBS = -fopenmp -lgomp
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
SHLIB_OPENMP_CFLAGS = -fopenmp
SHLIB_OPENMP_CXXFLAGS = -fopenmp
SHLIB_OPENMP_FCFLAGS = -fopenmp
SHLIB_OPENMP_FFLAGS = -fopenmp
FLIBS=-L/usr/local/lib/gcc/x86_64-apple-darwin15.6.0/7.1.0/finclude # change according to your computer compiler version
CFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
CXXFLAGS=-mtune=native -g -O2 -Wall -pedantic -Wconversion
```


#Installing Libraries

Below is how I setup most of my computers after a clean macOS install.
I start with **devtools** and **tidyverse** than **grur** my packge with the 
higher nnumber of dependencies, this way it's installing automatically 90%
of the packages I need (including **radiator**).
```{r}
if (!require("devtools")) install.packages("devtools") # to install
install.packages("tidyverse")
devtools::install_github("thierrygosselin/grur")
devtools::install_github("thierrygosselin/assigner")
```


#`rmetasim`

##Download
Download the latest github release (3.1.7) of Allan Strand's **rmetasim**
```{sh}
cd Downloads
wget https://github.com/stranda/rmetasim/archive/master.zip
unzip master.zip
```

##MAXLOCI

2000 loci is the built-in maximum. To use more, you need to modify rmetasim before compiling.
With a text editor [e.g. TextWrangler with macOS](http://gbs-cloud-tutorial.readthedocs.io/en/latest/03_computer_setup.html#install-textwrangler), modify the `const.h` file in the `src` folder: `rmetasim-master/src/const.h`.
Navigate to **lane 33** and change the integer to the desired maximum number of loci.

```{sh}
#define MAXLOCI               2000
```

```{sh}
#define MAXLOCI               20000
```

##Makevars configuration
*rmetasim* requires these Makevars specifications. If you have other lines, comment (#)
before compiling:


```{sh}
CC=/usr/local/bin/clang # -fopenmp
CC=/usr/local/bin/clang
CXX=/usr/local/bin/clang++
CXX1X=/usr/local/bin/clang++
FLIBS=-L/usr/local/lib
CFLAGS=-I/usr/local/include
LDFLAGS=-L/usr/local/lib
CPPFLAGS=-I/usr/local/include
SHLIB_OPENMP_CFLAGS= -fopenmp
SHLIB_OPENMP_FCFLAGS= -fopenmp
SHLIB_OPENMP_FFLAGS= -fopenmp
SHLIB_OPENMP_CXXFLAGS= -fopenmp
```


##Compile
```{sh}
R CMD INSTALL "rmetasim-master" # Terminal command
sudo rm -R rmetasim-master master.zip # to remove the folders no longer required
```

#`XGBoost`

##Download the github version
```{sh}
# terminal
cd Downloads
git clone --recursive https://github.com/dmlc/xgboost
cd xgboost
```

##Modification
Modify in a text editor the `configure` file inside the `xgboost/R-package` folder:
```{sh}
# Go to line 1676
# change
  ac_pkg_openmp=no
# to
  ac_pkg_openmp=yes
#save the file under the same name
```

##Makevars configuration

`XGBoost` requires these Makevars specifications. If you have other lines, comment (#)
before compiling:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CXX11=/usr/local/bin/g++
CXX14=/usr/local/bin/g++
CXX17=/usr/local/bin/g++
```


##Compile
```{sh}
sudo R CMD INSTALL R-package
```

##Test R-package
You should see a time difference between both runs
```{r}
require(xgboost)
x <-  matrix(rnorm(100*10000), 10000, 100)
y <-  x %*% rnorm(100) + rnorm(1000)

system.time({bst = xgboost(data = x, label = y, nthread = 1, nround = 100, verbose = FALSE)})
system.time({bst = xgboost(data = x, label = y, nthread = 4, nround = 100, verbose = FALSE)})
```


#`LightGBM`

`LightGBM` requires an OpenMP-enabled compiler. Currently, it doesn't work well with
clang, so make sure you have updated your GCC compiler (instructions above).
Additionally, `LightGBM` requires [CMake](https://cmake.org/overview/)

##Download and install CMake
```{sh}
cd Downloads
wget https://cmake.org/files/v3.10/cmake-3.10.0-rc3-Darwin-x86_64.dmg
# double-click on the disk image and follow instructions
```


To add CMake to the PATH:
```{sh}
PATH="/Applications/CMake.app/Contents/bin":"$PATH"
# Or, to install symlinks to '/usr/local/bin', run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install
# Or, to install symlinks to another directory, run:
sudo "/Applications/CMake.app/Contents/bin/cmake-gui" --install=/path/to/bin
Then, run the following commands to install LightGBM:
```

##Download and Install LightGBM
```{sh}
cd Downloads
git clone --recursive https://github.com/Microsoft/LightGBM
cd LightGBM/R-package
export CC=/usr/local/bin/gcc CXX=/usr/local/bin/g++
R CMD INSTALL --build . --no-multiarch
```



#`randomForestSRC`
[randomForestSRC](http://www.ccs.miami.edu/~hishwaran/rfsrc.html) requires 
the GCC OpenMP-enabled compiler to run in parallel. 
See instructions above if not already done.


##Makevars configuration
Check that the lines below **are not** commented in your `~/.R/Makevars` file:
```{sh}
CC=/usr/local/bin/gcc
CXX=/usr/local/bin/g++
CFLAGS=-g -O3 -Wall -pedantic -std=gnu99 -mtune=native -pipe
CXXFLAGS=-g -O3 -Wall -pedantic -std=c++11 -mtune=native -pipe
PKG_CFLAGS= -O3 -Wall -pipe -pedantic -std=gnu99 -fopenmp
PKG_CXXFLAGS=-fopenmp -std=c++11
```

##Download and install
From the Terminal run these steps to download and compile randomForestSRC:
```{sh}
cd ~/Downloads
curl -O http://www.ccs.miami.edu/~hishwaran/rfsrc/randomForestSRC_2.5.0.tar.gz
tar -zxvf randomForestSRC_2.5.0.tar.gz
cd randomForestSRC
autoconf
cd ..
R CMD INSTALL --preclean --clean randomForestSRC
```

You want to make sure that this line is printed during execution of the previous command:
`checking whether OpenMP will work in a package... yes`

If the compilation fails after `autoconf`, follow the first 3 steps in this
[tutorial](http://gbs-cloud-tutorial.readthedocs.io/en/latest/07_start_from_new_image.html?highlight=autoconf#install-gbs-radseq-software-time-required-30min), to install `libsigsegv`, `m4` and `autoconf`. 


#`ranger`
[ranger](https://github.com/imbs-hl/ranger) is easy to install.
```{r}
install.packages("ranger")
```

#`missRanger`
[missRanger](https://github.com/mayer79/missRanger) is also very easy to install.
```{r}
install.packages("missRanger")
```


#`pcaMethods`
To install [pcaMethods](https://github.com/hredestig/pcaMethods), from bioconductor:
```{r}
source("https://bioconductor.org/biocLite.R")
biocLite("pcaMethods")
```

#`fastsimcoal2`
To install [fastsimcoal2 v.2.6.0.3](http://cmpg.unibe.ch/software/fastsimcoal2/), to use in 
`grur::simulate_rad`:
```{sh}
# In a new Terminal window
#LINUX
wget http://cmpg.unibe.ch/software/fastsimcoal2/downloads/fsc26_linux64.zip
unzip fsc26_linux64.zip
sudo mv fsc26_linux64/fsc26 /usr/local/bin/fsc26
sudo chmod 777 /usr/local/bin/fsc26
#macOS
wget http://cmpg.unibe.ch/software/fastsimcoal2/downloads/fsc26_mac64.zip
unzip fsc26_mac64.zip
sudo mv fsc26_mac64/fsc26 /usr/local/bin/fsc26
sudo chmod 777 /usr/local/bin/fsc26
```
